<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Student Edit/Delete Functionality</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .student-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 10px 0;
            background: white;
            position: relative;
            transition: all 0.3s ease;
        }
        .student-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .action-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .student-card:hover .action-buttons {
            opacity: 1;
        }
        .btn {
            padding: 8px 12px;
            margin: 0 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        .btn-edit {
            background-color: #3b82f6;
            color: white;
        }
        .btn-edit:hover {
            background-color: #2563eb;
        }
        .btn-delete {
            background-color: #ef4444;
            color: white;
        }
        .btn-delete:hover {
            background-color: #dc2626;
        }
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-good { background-color: #dcfce7; color: #16a34a; }
        .status-warning { background-color: #fef3c7; color: #d97706; }
        .status-critical { background-color: #fee2e2; color: #dc2626; }
        .loading { color: #3b82f6; }
        .error { color: #ef4444; }
        .success { color: #10b981; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Student Edit/Delete Functionality</h1>
    
    <div class="test-section">
        <h3>üì° API Connection Test</h3>
        <button onclick="testAPIConnection()" class="btn btn-edit">Test API Connection</button>
        <div id="api-status"></div>
    </div>

    <div class="test-section">
        <h3>üë• Load Students</h3>
        <button onclick="loadStudents()" class="btn btn-edit">Load Students</button>
        <div id="students-status"></div>
        <div id="students-container"></div>
    </div>

    <div class="test-section">
        <h3>üìù Activity Log</h3>
        <div id="activity-log" class="log"></div>
        <button onclick="clearLog()" class="btn btn-delete">Clear Log</button>
    </div>

    <script>
        let students = [];
        let activityLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            activityLog.push(logEntry);
            
            const logElement = document.getElementById('activity-log');
            logElement.innerHTML = activityLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        function clearLog() {
            activityLog = [];
            document.getElementById('activity-log').innerHTML = '';
        }

        async function testAPIConnection() {
            const statusDiv = document.getElementById('api-status');
            statusDiv.innerHTML = '<div class="loading">üîÑ Testing API connection...</div>';
            log('Testing API connection...');

            try {
                const response = await fetch('http://localhost:5000/api/students?page=1&limit=1');
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="success">‚úÖ API connection successful</div>';
                    log('‚úÖ API connection successful');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå API connection failed: ${error.message}</div>`;
                log(`‚ùå API connection failed: ${error.message}`, 'error');
            }
        }

        async function loadStudents() {
            const statusDiv = document.getElementById('students-status');
            const containerDiv = document.getElementById('students-container');
            
            statusDiv.innerHTML = '<div class="loading">üîÑ Loading students...</div>';
            containerDiv.innerHTML = '';
            log('Loading students...');

            try {
                const response = await fetch('http://localhost:5000/api/students?page=1&limit=10');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                students = data.data || [];
                
                if (students.length === 0) {
                    statusDiv.innerHTML = '<div class="error">‚ùå No students found</div>';
                    log('‚ùå No students found');
                    return;
                }

                statusDiv.innerHTML = `<div class="success">‚úÖ Loaded ${students.length} students</div>`;
                log(`‚úÖ Loaded ${students.length} students`);
                
                renderStudents();
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">‚ùå Failed to load students: ${error.message}</div>`;
                log(`‚ùå Failed to load students: ${error.message}`, 'error');
            }
        }

        function renderStudents() {
            const containerDiv = document.getElementById('students-container');
            
            if (students.length === 0) {
                containerDiv.innerHTML = '<p>No students to display</p>';
                return;
            }

            containerDiv.innerHTML = students.map(student => `
                <div class="student-card" data-student-id="${student.studentId || student.id}">
                    <div class="action-buttons">
                        <button class="btn btn-edit" onclick="handleEdit('${student.studentId || student.id}', '${student.name}')">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-delete" onclick="handleDelete('${student.studentId || student.id}', '${student.name}')">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                    <h4>${student.name}</h4>
                    <p><strong>ID:</strong> ${student.studentId || student.id}</p>
                    <p><strong>Email:</strong> ${student.email || 'N/A'}</p>
                    <p><strong>Tingkat:</strong> ${student.tingkat || student.grade || 'N/A'}</p>
                    <p><strong>Kelas:</strong> ${student.kelas || student.class || 'N/A'}</p>
                    <div class="status status-${student.academicStatus || 'warning'}">
                        ${(student.academicStatus || 'warning').toUpperCase()}
                    </div>
                </div>
            `).join('');
        }

        async function handleEdit(studentId, studentName) {
            log(`üñäÔ∏è Edit button clicked for: ${studentName} (ID: ${studentId})`);
            
            try {
                // Find the student data
                const student = students.find(s => (s.studentId || s.id) === studentId);
                if (!student) {
                    throw new Error('Student not found in local data');
                }

                log(`üìÑ Student data found: ${JSON.stringify(student, null, 2)}`);

                // Simulate edit action - in real app this would open edit form
                const updatedName = prompt(`Edit name for ${studentName}:`, studentName);
                if (updatedName && updatedName !== studentName) {
                    await updateStudent(studentId, { ...student, name: updatedName });
                } else {
                    log('Edit cancelled or no changes made');
                }
            } catch (error) {
                log(`‚ùå Edit failed: ${error.message}`, 'error');
                alert(`Edit failed: ${error.message}`);
            }
        }

        async function handleDelete(studentId, studentName) {
            log(`üóëÔ∏è Delete button clicked for: ${studentName} (ID: ${studentId})`);
            
            if (!confirm(`Are you sure you want to delete ${studentName}?`)) {
                log('Delete cancelled by user');
                return;
            }

            try {
                await deleteStudent(studentId);
                log(`‚úÖ Student ${studentName} deleted successfully`);
                
                // Remove from local array and re-render
                students = students.filter(s => (s.studentId || s.id) !== studentId);
                renderStudents();
            } catch (error) {
                log(`‚ùå Delete failed: ${error.message}`, 'error');
                alert(`Delete failed: ${error.message}`);
            }
        }

        async function updateStudent(studentId, studentData) {
            log(`üîÑ Updating student ${studentId}...`);
            
            try {
                const response = await fetch(`http://localhost:5000/api/students/${studentId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(studentData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                const updatedStudent = await response.json();
                log(`‚úÖ Student updated successfully: ${JSON.stringify(updatedStudent, null, 2)}`);
                
                // Update local array
                const index = students.findIndex(s => (s.studentId || s.id) === studentId);
                if (index !== -1) {
                    students[index] = updatedStudent;
                    renderStudents();
                }
                
                return updatedStudent;
            } catch (error) {
                log(`‚ùå Update failed: ${error.message}`, 'error');
                throw error;
            }
        }

        async function deleteStudent(studentId) {
            log(`üîÑ Deleting student ${studentId}...`);
            
            try {
                const response = await fetch(`http://localhost:5000/api/students/${studentId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                log(`‚úÖ Student ${studentId} deleted from server`);
                return true;
            } catch (error) {
                log(`‚ùå Delete failed: ${error.message}`, 'error');
                throw error;
            }
        }

        // Auto-test on page load
        window.onload = function() {
            log('üöÄ Test page loaded');
            testAPIConnection();
        };
    </script>
</body>
</html>
