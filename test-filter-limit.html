<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter Limit Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .results {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .student-item {
            padding: 8px;
            margin: 5px 0;
            background-color: white;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .limit-controls {
            margin: 20px 0;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .stats {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        .stat-item {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            text-align: center;
            min-width: 80px;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Filter Limit Functionality Test</h1>
        <p>Testing the filter limit options (10, 100, 500, Semua/All) to verify they work correctly after backend fixes.</p>
        
        <div class="test-section">
            <h2>üìä Backend Data Overview</h2>
            <div class="stats" id="overview-stats">
                <div class="stat-item">
                    <div class="stat-number" id="total-students">-</div>
                    <div>Total Students</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="backend-status">-</div>
                    <div>Backend Status</div>
                </div>
            </div>
            <button onclick="testBackendOverview()">üîç Test Backend Overview</button>
            <div id="overview-results" class="results"></div>
        </div>

        <div class="test-section">
            <h2>üéØ Filter Limit Testing</h2>
            <div class="limit-controls">
                <label>Select Limit to Test:</label>
                <select id="limitSelect" onchange="updateLimitDisplay()">
                    <option value="10">10 Students</option>
                    <option value="100">100 Students</option>
                    <option value="500">500 Students</option>
                    <option value="1000">All Students (1000 limit)</option>
                </select>
                <button onclick="testFilterLimit()">üß™ Test Selected Limit</button>
                <button onclick="testAllLimits()">üéõÔ∏è Test All Limits</button>
            </div>
            
            <div class="stats" id="filter-stats">
                <div class="stat-item">
                    <div class="stat-number" id="requested-limit">10</div>
                    <div>Requested</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="received-count">-</div>
                    <div>Received</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="test-result">-</div>
                    <div>Status</div>
                </div>
            </div>
            
            <div id="filter-results" class="results"></div>
        </div>

        <div class="test-section">
            <h2>üîÑ Frontend Filter Simulation</h2>
            <p>Simulating how the frontend StudentView component would apply limit filters:</p>
            <div class="limit-controls">
                <button onclick="simulateFrontendFilter(10)">Simulate Limit 10</button>
                <button onclick="simulateFrontendFilter(100)">Simulate Limit 100</button>
                <button onclick="simulateFrontendFilter(500)">Simulate Limit 500</button>
                <button onclick="simulateFrontendFilter('semua')">Simulate All</button>
            </div>
            <div id="frontend-results" class="results"></div>
        </div>

        <div class="test-section">
            <h2>‚úÖ Integration Test</h2>
            <p>Complete end-to-end test simulating user interaction with filter limits:</p>
            <button onclick="runIntegrationTest()">üöÄ Run Complete Integration Test</button>
            <div id="integration-results" class="results"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let allStudents = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            return `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        function updateLimitDisplay() {
            const limit = document.getElementById('limitSelect').value;
            document.getElementById('requested-limit').textContent = limit === '1000' ? 'All' : limit;
        }

        async function testBackendOverview() {
            const resultsDiv = document.getElementById('overview-results');
            resultsDiv.innerHTML = log('üîÑ Testing backend connection and data overview...');

            try {
                // Test basic connection
                const response = await fetch(`${API_BASE}/students?limit=1000`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                allStudents = data.data || [];
                
                document.getElementById('total-students').textContent = data.totalRecords || allStudents.length;
                document.getElementById('backend-status').textContent = '‚úÖ';
                document.getElementById('backend-status').className = 'stat-number success';

                resultsDiv.innerHTML += log(`‚úÖ Backend connection successful`, 'success');
                resultsDiv.innerHTML += log(`üìä Total students in database: ${data.totalRecords || allStudents.length}`, 'info');
                resultsDiv.innerHTML += log(`üì¶ Students retrieved: ${allStudents.length}`, 'info');
                resultsDiv.innerHTML += log(`üìÑ Total pages: ${data.totalPages}`, 'info');

                // Show sample students
                if (allStudents.length > 0) {
                    resultsDiv.innerHTML += log(`üë• Sample students:`, 'info');
                    allStudents.slice(0, 3).forEach((student, index) => {
                        resultsDiv.innerHTML += `<div class="student-item">${index + 1}. ${student.name} (${student.email})</div>`;
                    });
                }

            } catch (error) {
                document.getElementById('backend-status').textContent = '‚ùå';
                document.getElementById('backend-status').className = 'stat-number error';
                resultsDiv.innerHTML += log(`‚ùå Backend test failed: ${error.message}`, 'error');
            }
        }

        async function testFilterLimit() {
            const limit = document.getElementById('limitSelect').value;
            const resultsDiv = document.getElementById('filter-results');
            
            resultsDiv.innerHTML = log(`üîÑ Testing limit filter: ${limit}...`);

            try {
                const actualLimit = limit === '1000' ? 1000 : parseInt(limit);
                const response = await fetch(`${API_BASE}/students?limit=${actualLimit}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const receivedCount = data.data?.length || 0;
                
                document.getElementById('received-count').textContent = receivedCount;
                
                // Determine test result
                let testStatus = '‚úÖ';
                let statusClass = 'success';
                
                if (limit === '1000') {
                    // For "all" - should get all available students
                    if (receivedCount === (data.totalRecords || receivedCount)) {
                        resultsDiv.innerHTML += log(`‚úÖ PASS: Retrieved all ${receivedCount} students`, 'success');
                    } else {
                        testStatus = '‚ö†Ô∏è';
                        statusClass = 'warning';
                        resultsDiv.innerHTML += log(`‚ö†Ô∏è WARNING: Expected all students, got ${receivedCount}`, 'warning');
                    }
                } else {
                    // For specific limits - should not exceed the limit
                    const expectedLimit = parseInt(limit);
                    if (receivedCount <= expectedLimit) {
                        resultsDiv.innerHTML += log(`‚úÖ PASS: Retrieved ${receivedCount} students (‚â§ ${expectedLimit} limit)`, 'success');
                    } else {
                        testStatus = '‚ùå';
                        statusClass = 'error';
                        resultsDiv.innerHTML += log(`‚ùå FAIL: Retrieved ${receivedCount} students (> ${expectedLimit} limit)`, 'error');
                    }
                }
                
                document.getElementById('test-result').textContent = testStatus;
                document.getElementById('test-result').className = `stat-number ${statusClass}`;

                // Show response details
                resultsDiv.innerHTML += log(`üìä Response details:`, 'info');
                resultsDiv.innerHTML += log(`   - Requested limit: ${actualLimit}`, 'info');
                resultsDiv.innerHTML += log(`   - Received count: ${receivedCount}`, 'info');
                resultsDiv.innerHTML += log(`   - Total pages: ${data.totalPages}`, 'info');
                resultsDiv.innerHTML += log(`   - Current page: ${data.currentPage}`, 'info');

            } catch (error) {
                document.getElementById('test-result').textContent = '‚ùå';
                document.getElementById('test-result').className = 'stat-number error';
                resultsDiv.innerHTML += log(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }

        async function testAllLimits() {
            const limits = ['10', '100', '500', '1000'];
            const resultsDiv = document.getElementById('filter-results');
            
            resultsDiv.innerHTML = log('üéõÔ∏è Testing all limit options...');

            for (const limit of limits) {
                try {
                    const actualLimit = limit === '1000' ? 1000 : parseInt(limit);
                    const response = await fetch(`${API_BASE}/students?limit=${actualLimit}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    const receivedCount = data.data?.length || 0;
                    
                    if (limit === '1000') {
                        resultsDiv.innerHTML += log(`‚úÖ Limit "All": ${receivedCount} students`, 'success');
                    } else {
                        const expectedLimit = parseInt(limit);
                        if (receivedCount <= expectedLimit) {
                            resultsDiv.innerHTML += log(`‚úÖ Limit ${limit}: ${receivedCount} students (‚â§ ${expectedLimit})`, 'success');
                        } else {
                            resultsDiv.innerHTML += log(`‚ùå Limit ${limit}: ${receivedCount} students (> ${expectedLimit})`, 'error');
                        }
                    }

                    // Small delay between requests
                    await new Promise(resolve => setTimeout(resolve, 100));

                } catch (error) {
                    resultsDiv.innerHTML += log(`‚ùå Limit ${limit} failed: ${error.message}`, 'error');
                }
            }

            resultsDiv.innerHTML += log('üéõÔ∏è All limits tested!', 'info');
        }

        function simulateFrontendFilter(limitValue) {
            const resultsDiv = document.getElementById('frontend-results');
            
            if (allStudents.length === 0) {
                resultsDiv.innerHTML = log('‚ùå No student data available. Run backend overview test first.', 'error');
                return;
            }

            resultsDiv.innerHTML = log(`üîÑ Simulating frontend filter with limit: ${limitValue}...`);

            // Simulate the StudentView filtering logic
            const filteredStudents = allStudents; // No search/status filters for this test
            
            // Apply limit filter (same logic as StudentView.tsx)
            const limitedStudents = limitValue === 'semua' 
                ? filteredStudents 
                : filteredStudents.slice(0, parseInt(limitValue));

            resultsDiv.innerHTML += log(`üìä Frontend filter simulation results:`, 'info');
            resultsDiv.innerHTML += log(`   - Total available: ${filteredStudents.length}`, 'info');
            resultsDiv.innerHTML += log(`   - After limit filter: ${limitedStudents.length}`, 'info');
            resultsDiv.innerHTML += log(`   - Limit setting: ${limitValue}`, 'info');

            // Verify the logic works correctly
            if (limitValue === 'semua') {
                if (limitedStudents.length === filteredStudents.length) {
                    resultsDiv.innerHTML += log(`‚úÖ PASS: "Semua" shows all students`, 'success');
                } else {
                    resultsDiv.innerHTML += log(`‚ùå FAIL: "Semua" doesn't show all students`, 'error');
                }
            } else {
                const expectedLimit = parseInt(limitValue);
                if (limitedStudents.length <= expectedLimit) {
                    resultsDiv.innerHTML += log(`‚úÖ PASS: Limited to ${limitedStudents.length} (‚â§ ${expectedLimit})`, 'success');
                } else {
                    resultsDiv.innerHTML += log(`‚ùå FAIL: Shows ${limitedStudents.length} (> ${expectedLimit})`, 'error');
                }
            }

            // Show sample limited students
            if (limitedStudents.length > 0) {
                resultsDiv.innerHTML += log(`üë• Students that would be displayed:`, 'info');
                limitedStudents.slice(0, Math.min(5, limitedStudents.length)).forEach((student, index) => {
                    resultsDiv.innerHTML += `<div class="student-item">${index + 1}. ${student.name}</div>`;
                });
                if (limitedStudents.length > 5) {
                    resultsDiv.innerHTML += `<div class="student-item">... and ${limitedStudents.length - 5} more students</div>`;
                }
            }
        }

        async function runIntegrationTest() {
            const resultsDiv = document.getElementById('integration-results');
            resultsDiv.innerHTML = log('üöÄ Running complete integration test...');

            try {
                // Step 1: Test backend connection
                resultsDiv.innerHTML += log('Step 1: Testing backend connection...', 'info');
                const response = await fetch(`${API_BASE}/students?limit=1000`);
                if (!response.ok) {
                    throw new Error(`Backend connection failed: ${response.status}`);
                }
                const data = await response.json();
                allStudents = data.data || [];
                resultsDiv.innerHTML += log(`‚úÖ Backend connection successful. ${allStudents.length} students available.`, 'success');

                // Step 2: Test all backend limits
                resultsDiv.innerHTML += log('Step 2: Testing backend limit handling...', 'info');
                const limits = [10, 100, 500];
                for (const limit of limits) {
                    const limitResponse = await fetch(`${API_BASE}/students?limit=${limit}`);
                    const limitData = await limitResponse.json();
                    const receivedCount = limitData.data?.length || 0;
                    
                    if (receivedCount <= limit) {
                        resultsDiv.innerHTML += log(`‚úÖ Backend limit ${limit}: ${receivedCount} students`, 'success');
                    } else {
                        resultsDiv.innerHTML += log(`‚ùå Backend limit ${limit}: ${receivedCount} students (exceeds limit)`, 'error');
                    }
                }

                // Step 3: Test frontend filtering simulation
                resultsDiv.innerHTML += log('Step 3: Testing frontend filter logic...', 'info');
                const frontendLimits = [10, 100, 500, 'semua'];
                for (const limitValue of frontendLimits) {
                    const filteredStudents = allStudents;
                    const limitedStudents = limitValue === 'semua' 
                        ? filteredStudents 
                        : filteredStudents.slice(0, parseInt(limitValue));
                    
                    if (limitValue === 'semua') {
                        if (limitedStudents.length === filteredStudents.length) {
                            resultsDiv.innerHTML += log(`‚úÖ Frontend "Semua": ${limitedStudents.length} students`, 'success');
                        } else {
                            resultsDiv.innerHTML += log(`‚ùå Frontend "Semua": incorrect count`, 'error');
                        }
                    } else {
                        const expectedLimit = parseInt(limitValue);
                        if (limitedStudents.length <= expectedLimit) {
                            resultsDiv.innerHTML += log(`‚úÖ Frontend limit ${limitValue}: ${limitedStudents.length} students`, 'success');
                        } else {
                            resultsDiv.innerHTML += log(`‚ùå Frontend limit ${limitValue}: ${limitedStudents.length} students (exceeds limit)`, 'error');
                        }
                    }
                }

                // Step 4: Overall assessment
                resultsDiv.innerHTML += log('Step 4: Integration test assessment...', 'info');
                resultsDiv.innerHTML += log('üéâ INTEGRATION TEST COMPLETE!', 'success');
                resultsDiv.innerHTML += log('‚úÖ Backend API: Working correctly', 'success');
                resultsDiv.innerHTML += log('‚úÖ Limit handling: Functioning properly', 'success');
                resultsDiv.innerHTML += log('‚úÖ Frontend filter logic: Implemented correctly', 'success');
                resultsDiv.innerHTML += log('üöÄ Filter limit feature is ready for use!', 'success');

            } catch (error) {
                resultsDiv.innerHTML += log(`‚ùå Integration test failed: ${error.message}`, 'error');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateLimitDisplay();
        });
    </script>
</body>
</html>
